---
title: "RNAscope R-Analysis"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
#download packages for managing r packages and excel
install.packages("pacman")
install.packages("readxl")
install.packages("tidyverse") 
install.packages("emmeans")
install.packages("afex")
install.packages("installr")
install.packages("conflicted")
install.packages("sandwich")
install.packages("lmtest")
install.packages("geepack")
install.packages("tibble")
install.packages("effectsize")
install.packages("lmerTest")
install.packages("ggpubr")
install.packages("ggdist")

```

```{r}
#load packages
library(pacman)
library(readxl)
library(tidyverse) #includes ggplot and dplyr
library(tibble)
library(emmeans)
library(conflicted)
library(afex)
library(lmerTest)  # For p-values in LMM
library(Matrix)
library(car)
library(tibble)
library(effectsize)
library(geepack)
library(ggpubr)
library(ggdist)
```

```{r}
setwd("C:/Users/nj35/OneDrive - University of St Andrews/RNAscope R-Analysis")
getwd()
```
###Nested Analysis LLM

```{r}
#load results file and make sure headings and levels are established

df_rna <- read.csv("RNAscope_processed.csv", header=TRUE)

#set to factor
df_rna$ID <- as.factor(df_rna$ID)
df_rna$Group <- as.factor(df_rna$Group)
df_rna$Group <- factor(df_rna$Group, levels = c("WT", "TDP"))

# Rename long variable names to simpler ones
names(df_rna)[names(df_rna) == "Channel_2_Op520.Intensity.Mean.Value"] <- "PV_mean"
names(df_rna)[names(df_rna) == "Channel_3_Op570.Intensity.Mean.Value"] <- "ESYT1_mean"
names(df_rna)[names(df_rna) == "Channel_4_Op690.Intensity.Mean.Value"] <- "SST_mean"
names(df_rna)[names(df_rna) == "Channel_2_Op520.Intensity.Standard.Deviation"] <- "PV_SD"
names(df_rna)[names(df_rna) == "Channel_3_Op570.Intensity.Standard.Deviation"] <- "ESYT1_SD"
names(df_rna)[names(df_rna) == "Channel_4_Op690.Intensity.Standard.Deviation"] <- "SST_SD"

# Convert the rest to numeric (intensity etc)
df_rna[ , 3:ncol(df_rna)] <- lapply(df_rna[ , 3:ncol(df_rna)], as.numeric)
```

```{r}
options(contrasts = c("contr.sum", "contr.poly"))
```


```{r}
str(df_rna)
```

###PV


```{r}
model_pv <- lmer(PV_mean ~ Group + (1 | ID:Group), data = df_rna, REML = TRUE)
summary(model_pv)
```
```{r}
anova(model_pv)
```


```{r}

t.test(PV_mean ~ Group, data = df_rna)

```


```{r}
# Obtain estimated marginal means
emm_pv <- emmeans(model_pv, ~ Group)
emm_pv
```
```{r}
#used for plotting
#convert emmeans to dataframe
emm_pv_df <- as.data.frame(emm_pv)
emm_pv_df
```


```{r}
# Convert the pairwise results into a data frame using summary
pairwise_results_pv <- summary(pairwise_pv)

# Filter significant results (p-value < 0.05)
sig_results_pv <- pairwise_results_pv %>%
  filter(p.value < 0.05)

# Add significance labels (***, **, *, ns)
sig_labels_pv <- pairwise_results_pv %>%
  mutate(
    label = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  )

# View labeled results
print(sig_labels_pv)
```

```{r}
#for plotting sig lines
sig_labels_pv <- summary(pairwise_pv) %>%
  mutate(
    group1 = "WT",
    group2 = "TDP",
    p.adj.signif = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ "ns"
    ),
    y.position = 2500
  ) %>%
  select(group1, group2, y.position, p.adj.signif)

sig_labels_pv
```

```{r}
#colour palette!!

wt_colours <- c("#feca8d", "#6a9e9e", "#b8de6f")
tdp_colours <- c("#440f76", "#f1605d", "#3f51b5")

# Create named color vector for all IDs by mapping Group to colors
id_colours <- c(
  setNames(wt_colours, unique(df_rna$ID[df_rna$Group == "WT"])),
  setNames(tdp_colours, unique(df_rna$ID[df_rna$Group == "TDP"]))
)
```


```{r}
# Create the plot
plot_pv <- ggplot(df_rna, aes(x = Group, y = PV_mean, fill = Group)) +
  
    # Half-violin, nudged left
  stat_halfeye(
    side = "left",
    adjust = 0.5,
    justification = 1.1,
    .width = 0,
    point_colour = NA,
    alpha = 0.6,
    scale = 0.5, #make plot narrower
    position = position_nudge(x = -0.05)
  ) +
  
  scale_fill_manual(values = c("WT" = "#d3d3d3", "TDP" = "#808080")) + #violin plot colour fill
  guides(fill = "none") + #remove legend
    
  
  #add means for SE bars
  geom_point(
    data = emm_pv_df,
    aes(x = Group, y = emmean),
    color = "black",
    size = 3.0,
    inherit.aes = FALSE,
    position = position_nudge(x = -0.15)
  ) +
  
    #adding in model SE data
  geom_errorbar(
    data = emm_pv_df,
    aes(x = Group, ymin = emmean - SE, ymax = emmean + SE),
    width = 0.10,
    inherit.aes = FALSE,
    linewidth = 0.6,
    position = position_nudge(x = -0.15)
  ) +
  
  # Labels for axes and legend
  labs(
    x = "Genotype",
    y = "Parvalbumin Mean Intensity ",
    color = NULL
  ) +
  # Apply clean theme
  theme_bw() +
  theme(
    text = element_text(size = 13),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    legend.box.margin = margin(0, 50, 0, 0),
    axis.text.x = element_text()
    )

# Add raw individual data points (from your etho_oft dataset)
plot_pv <- plot_pv + 
  geom_jitter(data = df_rna, aes(x = Group, y = PV_mean, color = ID), 
              size = 1.5, width = 0.1, alpha = 0.6, inherit.aes = FALSE) + 
  scale_color_manual(values = id_colours)

# Add in significant lines and astericks
plot_pv <- plot_pv +
  stat_pvalue_manual(sig_labels_pv, #stat_pvalue_manual is the function
                     label = "p.adj.signif", 
                     tip.length = 0.02, #changes dipped line bit
                     size = 5)
plot_pv
#ggsave("pv_graph.png", plot = plot_pv, width = 8, height = 6) #makes spaces visible
```


###ESYT1

```{r}
t.test(ESYT1_mean ~ Group, data = df_rna)
```


```{r}
model_esyt1 <- lmer(ESYT1_mean ~ Group + (1 | ID), data = df_rna, REML = TRUE)
summary(model_esyt1)
```

```{r}
# Obtain estimated marginal means
emm_esyt1 <- emmeans(model_esyt1, ~ Group)
emm_esyt1
```

```{r}
#used for plotting
#convert emmeans to dataframe
emm_esyt1_df <- as.data.frame(emm_esyt1)
emm_esyt1_df
```

```{r}
#pairwise comparison with tukey, due to lots of syllable comparisons (more tests)
pairwise_esyt1 <- contrast(emm_esyt1, method = "pairwise", adjust = "tukey") #bonferroni, Satterthwaite, Kenward-Roger, holm
summary(pairwise_esyt1)
```

```{r}
# Convert the pairwise results into a data frame using summary
pairwise_results_esyt1 <- summary(pairwise_esyt1)

# Filter significant results (p-value < 0.05)
sig_results_esyt1 <- pairwise_results_esyt1 %>%
  filter(p.value < 0.05)

# Add significance labels (***, **, *, ns)
sig_labels_esyt1 <- pairwise_results_esyt1 %>%
  mutate(
    label = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  )

# View labeled results
print(sig_labels_esyt1)
```
```{r}
#for plotting sig lines
sig_labels_esyt1 <- summary(pairwise_esyt1) %>%
  mutate(
    group1 = "WT",
    group2 = "TDP",
    p.adj.signif = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ "ns"
    ),
    y.position = 900
  ) %>%
  select(group1, group2, y.position, p.adj.signif)

sig_labels_esyt1
```

```{r}
#colour palette!!

wt_colours <- c("#feca8d", "#6a9e9e", "#b8de6f")
tdp_colours <- c("#440f76", "#f1605d", "#3f51b5")

# Create named color vector for all IDs by mapping Group to colors
id_colours <- c(
  setNames(wt_colours, unique(df_rna$ID[df_rna$Group == "WT"])),
  setNames(tdp_colours, unique(df_rna$ID[df_rna$Group == "TDP"]))
)
```

```{r}
# Create the plot
plot_esyt1 <- ggplot(df_rna, aes(x = Group, y = ESYT1_mean, fill = Group)) +
  
    # Half-violin, nudged left
  stat_halfeye(
    side = "left",
    adjust = 0.5,
    justification = 1.1,
    .width = 0,
    point_colour = NA,
    alpha = 0.6,
    scale = 0.5, #make plot narrower
    position = position_nudge(x = -0.05)
  ) +
  
  scale_fill_manual(values = c("WT" = "#d3d3d3", "TDP" = "#808080")) + #violin plot colour fill
  guides(fill = "none") + #remove legend
    
  
  #add means for SE bars
  geom_point(
    data = emm_esyt1_df,
    aes(x = Group, y = emmean),
    color = "black",
    size = 3.0,
    inherit.aes = FALSE,
    position = position_nudge(x = -0.15)
  ) +
  
    #adding in model SE data
  geom_errorbar(
    data = emm_esyt1_df,
    aes(x = Group, ymin = emmean - SE, ymax = emmean + SE),
    width = 0.10,
    inherit.aes = FALSE,
    linewidth = 0.6,
    position = position_nudge(x = -0.15)
  ) +
  
  # Labels for axes and legend
  labs(
    x = "Genotype",
    y = "ESYT1 Mean Intensity ",
    color = NULL
  ) +
  # Apply clean theme
  theme_bw() +
  theme(
    text = element_text(size = 13),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    legend.box.margin = margin(0, 50, 0, 0),
    axis.text.x = element_text()
    )

# Add raw individual data points (from your etho_oft dataset)
plot_esyt1 <- plot_esyt1 + 
  geom_jitter(data = df_rna, aes(x = Group, y = ESYT1_mean, color = ID), 
              size = 1.5, width = 0.1, alpha = 0.6, inherit.aes = FALSE) + 
  scale_color_manual(values = id_colours)

# Add in significant lines and astericks
plot_esyt1 <- plot_esyt1 +
  stat_pvalue_manual(sig_labels_esyt1, #stat_esyt1alue_manual is the function
                     label = "p.adj.signif", 
                     tip.length = 0.02, #changes dipped line bit
                     size = 5)
plot_esyt1
#ggsave("esyt1_graph.png", plot = plot_esyt1, width = 8, height = 6) #makes spaces visible
```
###SST

```{r}
model_sst <- lmer(SST_mean ~ Group + (1 | ID), data = df_rna, REML = TRUE)
summary(model_sst)
```

```{r}
# Obtain estimated marginal means
emm_sst <- emmeans(model_sst, ~ Group)
emm_sst
```

```{r}
#used for plotting
#convert emmeans to dataframe
emm_sst_df <- as.data.frame(emm_sst)
emm_sst_df
```

```{r}
#pairwise comparison with tukey, due to lots of syllable comparisons (more tests)
pairwise_sst <- contrast(emm_sst, method = "pairwise", adjust = "tukey") #bonferroni, Satterthwaite, Kenward-Roger, holm
summary(pairwise_sst)
```

```{r}
# Convert the pairwise results into a data frame using summary
pairwise_results_sst <- summary(pairwise_sst)

# Filter significant results (p-value < 0.05)
sig_results_sst <- pairwise_results_sst %>%
  filter(p.value < 0.05)

# Add significance labels (***, **, *, ns)
sig_labels_sst <- pairwise_results_sst %>%
  mutate(
    label = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  )

# View labeled results
print(sig_labels_sst)
```

```{r}
#for plotting sig lines
sig_labels_sst <- summary(pairwise_sst) %>%
  mutate(
    group1 = "WT",
    group2 = "TDP",
    p.adj.signif = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ "ns"
    ),
    y.position = 2600
  ) %>%
  select(group1, group2, y.position, p.adj.signif)

sig_labels_sst
```

```{r}
#colour palette!!

wt_colours <- c("#feca8d", "#6a9e9e", "#b8de6f")
tdp_colours <- c("#440f76", "#f1605d", "#3f51b5")

# Create named color vector for all IDs by mapping Group to colors
id_colours <- c(
  setNames(wt_colours, unique(df_rna$ID[df_rna$Group == "WT"])),
  setNames(tdp_colours, unique(df_rna$ID[df_rna$Group == "TDP"]))
)
```

```{r}
# Create the plot
plot_sst <- ggplot(df_rna, aes(x = Group, y = SST_mean, fill = Group)) +
  
    # Half-violin, nudged left
  stat_halfeye(
    side = "left",
    adjust = 0.5,
    justification = 1.1,
    .width = 0,
    point_colour = NA,
    alpha = 0.6,
    scale = 0.5, #make plot narrower
    position = position_nudge(x = -0.05)
  ) +
  
  scale_fill_manual(values = c("WT" = "#d3d3d3", "TDP" = "#808080")) + #violin plot colour fill
  guides(fill = "none") + #remove legend
    
  
  #add means for SE bars
  geom_point(
    data = emm_sst_df,
    aes(x = Group, y = emmean),
    color = "black",
    size = 3.0,
    inherit.aes = FALSE,
    position = position_nudge(x = -0.15)
  ) +
  
    #adding in model SE data
  geom_errorbar(
    data = emm_sst_df,
    aes(x = Group, ymin = emmean - SE, ymax = emmean + SE),
    width = 0.10,
    inherit.aes = FALSE,
    linewidth = 0.6,
    position = position_nudge(x = -0.15)
  ) +
  
  # Labels for axes and legend
  labs(
    x = "Genotype",
    y = "sst Mean Intensity ",
    color = NULL
  ) +
  # Apply clean theme
  theme_bw() +
  theme(
    text = element_text(size = 13),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    legend.box.margin = margin(0, 50, 0, 0),
    axis.text.x = element_text()
    )

# Add raw individual data points (from your etho_oft dataset)
plot_sst <- plot_sst + 
  geom_jitter(data = df_rna, aes(x = Group, y = SST_mean, color = ID), 
              size = 1.5, width = 0.1, alpha = 0.6, inherit.aes = FALSE) + 
  scale_color_manual(values = id_colours)

# Add in significant lines and astericks
plot_sst <- plot_sst +
  stat_pvalue_manual(sig_labels_sst, #stat_sstalue_manual is the function
                     label = "p.adj.signif", 
                     tip.length = 0.02, #changes dipped line bit
                     size = 5)
plot_sst
#ggsave("sst_graph.png", plot = plot_sst, width = 8, height = 6) #makes spaces visible
```

